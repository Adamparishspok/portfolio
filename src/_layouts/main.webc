<!DOCTYPE html>
<html lang="en" class="scroll-smooth" color-scheme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#08090A" />
    <meta name="author" content="Adam Parish" />
    <link rel="canonical" :href="base.domain + page.url" />

    <!--- Preconnect to critical third-party origins --->
    <link rel="preconnect" href="https://us.i.posthog.com" crossorigin />
    <link rel="preconnect" href="https://assets.unicorn.studio" />
    <link rel="preconnect" href="https://tr.lfeeder.com" />
    <link rel="preconnect" href="https://unpkg.com" />
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />

    <!--- Preload Fonts --->
    <link
      rel="preload"
      href="/assets/fonts/Geist-Variable.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/assets/fonts/GeistMono-Variable.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />

    <!--- Search + Tab --->
    <title @html="this.seoTitle"></title>
    <meta name="description" :content="this.seoDesc" />

    <!--- OpenGraph --->
    <meta property="og:site_name" :content="base.name" />
    <meta property="og:type" content="website" />
    <meta property="og:title" :content="this.ogTitle" />
    <meta property="og:description" :content="this.ogDesc" />
    <meta property="og:url" :content="base.url + page.url" />
    <meta property="og:image" :content="base.url + this.ogImage" />
    <meta property="og:image:alt" :content="this.ogImageAlt || this.seoTitle" />

    <!--- Twitter --->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" :content="base.twitterHandle" />
    <meta name="twitter:creator" :content="base.twitterHandle" />

    <!--- Prevent Indexing --->
    <meta webc:if="this.noindex" name="robots" content="noindex, nofollow" />

    <script type="application/ld+json" webc:keep>
      {
        "@context": "https://schema.org",
        "@type": "Person",
        "name": "Adam Parish",
        "url": "https://atomparish.com",
        "sameAs": [
          "https://twitter.com/atomparish1",
          "https://www.linkedin.com/in/atomizer/",
          "https://dribbble.com/atomparish/",
          "https://github.com/atompariskspok"
        ],
        "jobTitle": "Lead Product Designer",
        "worksFor": {
          "@type": "Organization",
          "name": "Atomic FI"
        }
      }
    </script>

    <script>
      (function (ss, ex) {
        window.ldfdr =
          window.ldfdr ||
          function () {
            (ldfdr._q = ldfdr._q || []).push([].slice.call(arguments));
          };
        (function (d, s) {
          fs = d.getElementsByTagName(s)[0];
          function ce(src) {
            var cs = d.createElement(s);
            cs.src = src;
            cs.async = 1;
            fs.parentNode.insertBefore(cs, fs);
          }
          ce('https://sc.lfeeder.com/lftracker_v1_' + ss + (ex ? '_' + ex : '') + '.js');
        })(document, 'script');
      })('ywVkO4XmPpzaZ6Bj');
    </script>

    <!--- Light/Dark Mode: Set from localStorage or system preference --->
    <script webc:keep>
      (function () {
        const scheme =
          localStorage.getItem('scheme') ||
          (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('color-scheme', scheme);
      })();
    </script>

    <!--- Fonts --->
    <style>
      :root {
        font-family:
          'Geist Sans', 'ui-sans-serif', 'system-ui', 'sans-serif', 'Apple Color Emoji',
          'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        font-weight: 400;
        -webkit-font-smoothing: antialiased;
      }
    </style>

    <!--- Styles --->
    <link rel="stylesheet" href="/assets/css/main.css" webc:keep />
    <link webc:if="markdown" rel="stylesheet" href="/assets/css/markdown.css" webc:keep />
    <style @raw="getBundle('css')" webc:keep></style>

    <!--- Icons --->
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Adam P" />
    <link rel="manifest" href="/site.webmanifest" />

    <!--- PostHog - Deferred for performance --->
    <script defer webc:keep src="/assets/js/posthog.min.js"></script>
    <script defer>
      // Defer scripts execute after DOM parsing, so no DOMContentLoaded wrapper needed
      if (window.posthog) {
        window.posthog.init('phc_PVCwdgCGgAV76xJR6eA2DxTEwiqejQpFaUyz4oo8ltz', {
          api_host: 'https://us.i.posthog.com',
          person_profiles: 'identified_only',
          // Disable heavy features not needed
          disable_session_recording: false,
          disable_surveys: true,
          autocapture: false,
          capture_pageview: false,
          capture_pageleave: false,
        });
        // Send initial page load event
        window.posthog.capture('website_loaded', {
          page_url: window.location.href,
          timestamp: new Date().toISOString(),
        });
      }
    </script>
    <!--- Portfolio Analytics - Deferred --->
    <script defer webc:keep src="/assets/js/analytics.js"></script>

    <!--- Text Scramble Effect - Deferred --->
    <script defer webc:keep src="/assets/js/text-scramble.js"></script>

    <!--- Holographic 3D Effect - Deferred --->
    <script defer webc:keep src="/assets/js/holographic-effect.js"></script>

    <!--- UnicornStudio SDK - loaded in head for faster rendering --->
    <script webc:raw type="text/javascript">
      !(function () {
        // Check for WebGL support before loading UnicornStudio
        function hasWebGLSupport() {
          try {
            var canvas = document.createElement('canvas');
            var gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            return !!gl;
          } catch (e) {
            return false;
          }
        }

        // Initialize UnicornStudio after DOM is ready
        function initUnicornStudio() {
          try {
            if (
              window.UnicornStudio &&
              typeof UnicornStudio.init === 'function' &&
              !window.UnicornStudio.isInitialized
            ) {
              UnicornStudio.init();
              window.UnicornStudio.isInitialized = true;
              window.UnicornStudio.isReady = true;
              // Dispatch event to signal UnicornStudio is ready
              window.dispatchEvent(new CustomEvent('unicornStudioReady'));
            }
          } catch (e) {
            console.warn('UnicornStudio initialization failed:', e.message);
          }
        }

        if (!window.UnicornStudio && hasWebGLSupport()) {
          window.UnicornStudio = { isInitialized: false, isReady: false };
          var i = document.createElement('script');
          i.src =
            'https://cdn.jsdelivr.net/gh/hiunicornstudio/unicornstudio.js@v1.4.34/dist/unicornStudio.umd.js';
          i.onload = function () {
            // Wait for DOM to be ready before initializing
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', initUnicornStudio);
            } else {
              // DOM is already ready - add small delay to ensure elements are fully rendered
              setTimeout(initUnicornStudio, 100);
            }
          };
          i.onerror = function () {
            console.warn('Failed to load UnicornStudio SDK');
          };
          (document.head || document.body).appendChild(i);
        }
      })();
    </script>

    <!--- Axe-core for accessibility testing (development only) --->
    <script webc:if="env !== 'production'" webc:keep src="/assets/js/axe-core.js"></script>

    <script async webc:keep src="https://www.googletagmanager.com/gtag/js?id=G-3BCTP3WC02"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'G-3BCTP3WC02');
    </script>
  </head>

  <body
    class="flex min-h-screen flex-col text-zinc-400 antialiased selection:bg-zinc-800 selection:text-zinc-100"
  >
    <!-- Skip to main content link for keyboard navigation -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:bg-white focus:px-4 focus:py-2 focus:text-black focus:no-underline focus:ring-2 focus:ring-indigo-500 focus:outline-none"
    >
      Skip to main content
    </a>

    <div
      class="aura-background-component fixed top-0 left-0 -z-10 h-screen w-full"
      data-alpha-mask="80"
      style="
        mask-image: linear-gradient(to bottom, transparent, black 0%, black 80%, transparent);
        -webkit-mask-image: linear-gradient(
          to bottom,
          transparent,
          black 0%,
          black 80%,
          transparent
        );
      "
    >
      <div
        data-us-project="0WrRbFIPaKoWVkiQWBG0"
        data-us-production="true"
        data-us-scale="0.75"
        data-us-dpi="1.5"
        data-us-fps="60"
        data-us-alttext="Animated background scene"
        data-us-arialabel="Decorative animated background"
        class="absolute top-0 left-0 -z-10 h-full w-full"
      ></div>
    </div>

    <div
      id="page-transition"
      class="pointer-events-none fixed inset-0 z-40 bg-black opacity-0 transition-opacity duration-500"
    ></div>

    <div
      class="relative mx-auto flex min-h-screen w-full max-w-[1400px] flex-col border-x border-white/10 bg-[#08090A]/40"
    >
      <site-header :base="base" :navigation="navigation"></site-header>
      <main
        id="main-content"
        class="relative grid grow grid-cols-1 divide-y divide-white/10 md:grid-cols-12 md:divide-x md:divide-y-0"
        @html="this.content"
      ></main>
      <site-footer :base="base"></site-footer>
    </div>

    <!--- Motion Library - Lightweight animation utility --->
    <script defer webc:keep src="/assets/js/motion.js"></script>
    <script defer @raw="getBundle('js')" webc:keep></script>

    <!-- Lucide Icons - Deferred -->
    <script defer webc:keep src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script defer webc:keep>
      // Initialize Lucide icons when the library loads
      function initLucideIcons() {
        if (window.lucide && typeof lucide.createIcons === 'function') {
          lucide.createIcons();
        } else {
          // Retry if lucide hasn't loaded yet
          setTimeout(initLucideIcons, 50);
        }
      }

      // Start initialization
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLucideIcons);
      } else {
        initLucideIcons();
      }
    </script>

    <script type="module">
      class PageTransition {
        constructor() {
          this.mainContent = document.getElementById('main-content');
          this.overlay = document.getElementById('page-transition');
          this.isTransitioning = false;
          this.supportsVT = 'startViewTransition' in document;

          if ('scrollRestoration' in history) {
            history.scrollRestoration = 'manual';
          }

          this.init();
        }

        init() {
          this.bindEvents();
          this.animateInitialContent();
        }

        bindEvents() {
          document.addEventListener('click', this.handleClick.bind(this));
          window.addEventListener('popstate', () => this.handleNavigation(location.href));
        }

        handleClick(e) {
          const link = e.target.closest('a[href]');
          if (!link) return;

          const href = link.href;
          const url = new URL(href, location.href);

          // Skip external, etc.
          if (
            url.origin !== location.origin ||
            link.hasAttribute('download') ||
            link.hasAttribute('target') ||
            href.startsWith('mailto:') ||
            href.startsWith('tel:') ||
            href.startsWith('javascript:')
          ) return;

          e.preventDefault();

          if (url.pathname === location.pathname && url.hash) {
            history.replaceState(null, '', url.hash);
            this.scrollToHash(url.hash.slice(1));
            return;
          } else {
            this.handleNavigation(href);
          }
        }

        // THIS IS THE FIXED VERSION
        async handleNavigation(url) {
          if (this.isTransitioning) return;
          this.isTransitioning = true;

          const targetUrl = new URL(url, location.href);
          const hash = targetUrl.hash.slice(1);

          // CHANGE #1: Always append .html if the path ends with /
          let fetchUrl = targetUrl.pathname;
          if (fetchUrl === '/' || fetchUrl.endsWith('/')) {
            fetchUrl = fetchUrl + 'index.html';
          } else if (!fetchUrl.endsWith('.html')) {
            fetchUrl = fetchUrl + '.html';
          }
          // Also preserve search params if any
          if (targetUrl.search) fetchUrl += targetUrl.search;

          try {
            const res = await fetch(fetchUrl);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const html = await res.text();
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const newContent = doc.querySelector('#main-content');
            const newTitle = doc.querySelector('title')?.textContent || 'Adam Parish';

            if (!newContent) {
              document.title = newTitle;

              if (this.supportsVT) {
                const transition = document.startViewTransition(() => {
                  this.mainContent.innerHTML = newContent.innerHTML;
                  this.reinitDynamicContent();
                  window.scrollTo(0, 0);
                });
                await transition.finished;
              } else {
                this.showOverlay();
                await Motion.to(this.mainContent, { opacity: 0, duration: 0.3 });
                this.mainContent.innerHTML = newContent.innerHTML;
                this.reinitDynamicContent();
                window.scrollTo(0, 0);
                await Motion.to(this.mainContent, { opacity: 1, duration: 0.5 });
                this.hideOverlay();
              }

              // CHANGE #2: Use the original URL (not the .html one) for history
              const finalUrl = hash ? `${targetUrl.pathname}${targetUrl.search}#${hash}` : targetUrl.pathname + targetUrl.search;
              history.pushState({ url: finalUrl }, '', finalUrl);

              this.animateInContent();

              if (hash) {
                setTimeout(() => this.scrollToHash(hash), 100);
              }
            } else {
              // If no #main-content, fallback to full reload
              location.href = url;
            }
          } catch (err) {
            location.href = url; // hard fallback
          } finally {
            this.isTransitioning = false;
          }
        }

        // ... rest of the methods (animateInContent, reinitDynamicContent, etc.) stay exactly the same
        scrollToHash(id) { ... }
        animateInitialContent() { ... }
        animateInContent() { ... }
        showOverlay() { ... }
        hideOverlay() { ... }
        reinitDynamicContent() { ... }
      }

      // Init â€” unchanged
      const init = () => {
        if (window.Motion) new PageTransition();
        else {
          let attempts = 0;
          const i = setInterval(() => {
            if (window.Motion || attempts++ > 100) {
              clearInterval(i);
              if (window.Motion) new PageTransition();
            }
          }, 50);
        }
      };
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
      else init();
    </script>
  </body>
</html>
